"""
测试 STTInputProviderConfig 配置

运行: uv run pytest tests/domains/input/providers/stt/test_stt_config.py -v
"""

import pytest
from src.domains.input.providers.stt.config import (
    STTInputProviderConfig,
    IflytekAsrConfig,
    VadConfig,
    AudioConfig,
    MessageConfig,
)


# =============================================================================
# IflytekAsrConfig 测试
# =============================================================================


def test_iflytek_asr_config_creation():
    """测试讯飞 ASR 配置创建"""
    config = IflytekAsrConfig(
        appid="test_appid",
        api_key="test_key",
        api_secret="test_secret",
    )
    assert config.appid == "test_appid"
    assert config.api_key == "test_key"
    assert config.api_secret == "test_secret"


def test_iflytek_asr_config_defaults():
    """测试讯飞 ASR 配置默认值"""
    config = IflytekAsrConfig(
        appid="test_appid",
        api_key="test_key",
        api_secret="test_secret",
    )

    assert config.host == "iat-api.xfyun.cn"
    assert config.path == "/v2/iat"
    assert config.language == "zh_cn"
    assert config.domain == "iat"
    assert config.accent == "mandarin"
    assert config.ptt == 1
    assert config.rlang == "zh-cn"
    assert config.vinfo == 1
    assert config.dwa == "wpgs"


def test_iflytek_asr_config_custom_values():
    """测试自定义讯飞 ASR 配置"""
    config = IflytekAsrConfig(
        appid="test_appid",
        api_key="test_key",
        api_secret="test_secret",
        host="custom.host.com",
        language="en_us",
    )

    assert config.host == "custom.host.com"
    assert config.language == "en_us"


def test_iflytek_asr_config_validation():
    """测试讯飞 ASR 配置验证"""
    # 缺少必需字段应该失败
    with pytest.raises(pydantic_core._pydantic_core.ValidationError):
        IflytekAsrConfig(appid="test")  # 缺少 api_key 和 api_secret


# =============================================================================
# VadConfig 测试
# =============================================================================


def test_vad_config_creation():
    """测试 VAD 配置创建"""
    config = VadConfig()
    assert config.enable is True
    assert config.vad_threshold == 0.5
    assert config.silence_seconds == 1.0


def test_vad_config_custom_values():
    """测试自定义 VAD 配置"""
    config = VadConfig(enable=False, vad_threshold=0.8, silence_seconds=2.0)
    assert config.enable is False
    assert config.vad_threshold == 0.8
    assert config.silence_seconds == 2.0


def test_vad_config_threshold_range():
    """测试 VAD 阈值范围"""
    # 测试不同阈值
    config1 = VadConfig(vad_threshold=0.0)
    assert config1.vad_threshold == 0.0

    config2 = VadConfig(vad_threshold=1.0)
    assert config2.vad_threshold == 1.0


# =============================================================================
# AudioConfig 测试
# =============================================================================


def test_audio_config_creation():
    """测试音频配置创建"""
    config = AudioConfig()
    assert config.sample_rate == 16000
    assert config.channels == 1
    assert config.dtype == "int16"


def test_audio_config_custom_values():
    """测试自定义音频配置"""
    config = AudioConfig(sample_rate=8000, channels=2, dtype="float32")
    assert config.sample_rate == 8000
    assert config.channels == 2
    assert config.dtype == "float32"


def test_audio_config_device_name():
    """测试音频设备名称"""
    config = AudioConfig(stt_input_device_name="麦克风 (Realtek)")
    assert config.stt_input_device_name == "麦克风 (Realtek)"


def test_audio_config_remote_stream():
    """测试远程音频流配置"""
    config = AudioConfig(use_remote_stream=True)
    assert config.use_remote_stream is True


# =============================================================================
# MessageConfig 测试
# =============================================================================


def test_message_config_creation():
    """测试消息配置创建"""
    config = MessageConfig()
    assert config.user_id == "stt_user"
    assert config.user_nickname == "语音"
    assert config.user_cardname == ""
    assert config.enable_group_info is False
    assert config.group_id == "stt_group"
    assert config.group_name == "stt_default"


def test_message_config_custom_values():
    """测试自定义消息配置"""
    config = MessageConfig(
        user_id="custom_user",
        user_nickname="自定义语音",
        group_id="custom_group",
    )
    assert config.user_id == "custom_user"
    assert config.user_nickname == "自定义语音"
    assert config.group_id == "custom_group"


def test_message_config_content_format():
    """测试内容格式配置"""
    config = MessageConfig(content_format=["text", "emoji"])
    assert config.content_format == ["text", "emoji"]


def test_message_config_accept_format():
    """测试接受格式配置"""
    config = MessageConfig(accept_format=["text", "vts_command"])
    assert "text" in config.accept_format
    assert "vts_command" in config.accept_format


def test_message_config_template_info():
    """测试模板信息配置"""
    config = MessageConfig(
        enable_template_info=True,
        template_items={"key1": "value1"},
    )
    assert config.enable_template_info is True
    assert config.template_items == {"key1": "value1"}


def test_message_config_context_tags():
    """测试上下文标签配置"""
    config = MessageConfig(context_tags=["tag1", "tag2"])
    assert config.context_tags == ["tag1", "tag2"]


def test_message_config_correction():
    """测试文本修正配置"""
    config = MessageConfig(enable_correction=False)
    assert config.enable_correction is False


def test_message_config_additional_config():
    """测试额外配置"""
    config = MessageConfig(additional_config={"custom_key": "custom_value"})
    assert config.additional_config == {"custom_key": "custom_value"}


# =============================================================================
# STTInputProviderConfig 测试
# =============================================================================


def test_stt_input_provider_config_creation():
    """测试 STT Provider 配置创建"""
    config = STTInputProviderConfig(
        iflytek_asr=IflytekAsrConfig(
            appid="test_appid",
            api_key="test_key",
            api_secret="test_secret",
        ),
        vad=VadConfig(),
        audio=AudioConfig(),
        message_config=MessageConfig(),
    )

    assert config.type == "stt"
    assert config.iflytek_asr.appid == "test_appid"
    assert config.vad.enable is True
    assert config.audio.sample_rate == 16000
    assert config.message_config.user_id == "stt_user"


def test_stt_input_provider_config_defaults():
    """测试 STT Provider 配置默认值"""
    config = STTInputProviderConfig(
        iflytek_asr=IflytekAsrConfig(
            appid="test_appid",
            api_key="test_key",
            api_secret="test_secret",
        )
    )

    # 嵌套配置应该有默认值
    assert isinstance(config.vad, VadConfig)
    assert isinstance(config.audio, AudioConfig)
    assert isinstance(config.message_config, MessageConfig)


def test_stt_input_provider_config_validation():
    """测试 STT Provider 配置验证"""
    # 缺少 iflytek_asr 应该失败
    with pytest.raises(pydantic_core._pydantic_core.ValidationError):
        STTInputProviderConfig()


# =============================================================================
# 序列化测试
# =============================================================================


def test_iflytek_asr_config_serialization():
    """测试讯飞 ASR 配置序列化"""
    config = IflytekAsrConfig(
        appid="test_appid",
        api_key="test_key",
        api_secret="test_secret",
    )
    data = config.model_dump()

    assert data["appid"] == "test_appid"
    assert data["api_key"] == "test_key"
    assert data["api_secret"] == "test_secret"


def test_vad_config_serialization():
    """测试 VAD 配置序列化"""
    config = VadConfig(enable=True, vad_threshold=0.8)
    data = config.model_dump()

    assert data["enable"] is True
    assert data["vad_threshold"] == 0.8


def test_audio_config_serialization():
    """测试音频配置序列化"""
    config = AudioConfig(sample_rate=8000, stt_input_device_name="test_device")
    data = config.model_dump()

    assert data["sample_rate"] == 8000
    assert data["stt_input_device_name"] == "test_device"


def test_message_config_serialization():
    """测试消息配置序列化"""
    config = MessageConfig(user_id="test_user", context_tags=["tag1"])
    data = config.model_dump()

    assert data["user_id"] == "test_user"
    assert data["context_tags"] == ["tag1"]


def test_stt_input_provider_config_serialization():
    """测试 STT Provider 配置完整序列化"""
    config = STTInputProviderConfig(
        iflytek_asr=IflytekAsrConfig(
            appid="test_appid",
            api_key="test_key",
            api_secret="test_secret",
        ),
        vad=VadConfig(enable=False),
        audio=AudioConfig(sample_rate=8000),
    )

    data = config.model_dump()

    assert data["type"] == "stt"
    assert data["iflytek_asr"]["appid"] == "test_appid"
    assert data["vad"]["enable"] is False
    assert data["audio"]["sample_rate"] == 8000


# =============================================================================
# 反序列化测试
# =============================================================================


def test_iflytek_asr_config_deserialization():
    """测试讯飞 ASR 配置反序列化"""
    data = {
        "appid": "test_appid",
        "api_key": "test_key",
        "api_secret": "test_secret",
        "host": "custom.host.com",
    }
    config = IflytekAsrConfig(**data)

    assert config.appid == "test_appid"
    assert config.host == "custom.host.com"


def test_stt_input_provider_config_deserialization():
    """测试 STT Provider 配置反序列化"""
    data = {
        "type": "stt",
        "iflytek_asr": {
            "appid": "test_appid",
            "api_key": "test_key",
            "api_secret": "test_secret",
        },
        "vad": {"enable": False, "vad_threshold": 0.8},
        "audio": {"sample_rate": 8000},
    }
    config = STTInputProviderConfig(**data)

    assert config.iflytek_asr.appid == "test_appid"
    assert config.vad.enable is False
    assert config.audio.sample_rate == 8000


# =============================================================================
# 边界条件测试
# =============================================================================


def test_empty_string_fields():
    """测试空字符串字段"""
    config = MessageConfig(user_id="", user_nickname="")
    assert config.user_id == ""
    assert config.user_nickname == ""


def test_zero_values():
    """测试零值"""
    config = VadConfig(vad_threshold=0.0)
    config2 = AudioConfig(sample_rate=0)
    assert config.vad_threshold == 0.0
    assert config2.sample_rate == 0


def test_negative_values():
    """测试负值（如果允许）"""
    config = VadConfig(vad_threshold=-0.5)  # 可能不合理但测试 Pydantic 行为
    assert config.vad_threshold == -0.5


if __name__ == "__main__":
    pytest.main([__file__, "-v", "-s"])
