# Amaidesu æ¶æ„é‡æ„æ–‡æ¡£ç´¢å¼•

> **ç‰ˆæœ¬**: v3.0
> **æ—¥æœŸ**: 2025-02-01
> **çŠ¶æ€**: æ’ä»¶ç³»ç»Ÿå·²ç§»é™¤ï¼Œé‡‡ç”¨çº¯Provideræ¶æ„

---

## ğŸ“‹ å¿«é€Ÿå¯¼èˆª

### æˆ‘æƒ³äº†è§£...

**æ•´ä½“æ¶æ„æ˜¯ä»€ä¹ˆï¼Ÿ**
â†’ [è®¾è®¡æ€»è§ˆ](./design/overview.md)

**5å±‚æ¶æ„å¦‚ä½•å·¥ä½œï¼Ÿ**
â†’ [5å±‚æ¶æ„è®¾è®¡](./design/layer_refactoring.md)

**å†³ç­–å±‚å¦‚ä½•å¯æ›¿æ¢ï¼Ÿ**
â†’ [å†³ç­–å±‚è®¾è®¡](./design/decision_layer.md)

**å¤šä¸ªProviderå¦‚ä½•å¹¶å‘ï¼Ÿ**
â†’ [å¤šProviderå¹¶å‘è®¾è®¡](./design/multi_provider.md)

**âš ï¸ æ’ä»¶ç³»ç»Ÿä¸ºä»€ä¹ˆç§»é™¤ï¼Ÿ**
â†’ [æ’ä»¶ç³»ç»Ÿç§»é™¤è¯´æ˜](./PLUGIN_SYSTEM_REMOVAL.md)

**AmaidesuCoreå¦‚ä½•é‡æ„ï¼Ÿ**
â†’ [æ ¸å¿ƒé‡æ„è®¾è®¡](./design/core_refactoring.md)

**HTTPæœåŠ¡å™¨å¦‚ä½•ç®¡ç†ï¼Ÿ**
â†’ [HTTPæœåŠ¡å™¨è®¾è®¡](./design/http_server.md)

**å¦‚ä½•å®æ–½é‡æ„ï¼Ÿ**
â†’ [5å±‚æ¶æ„é‡æ„å®æ–½è®¡åˆ’](./plan/5_layer_refactoring_plan.md)

---

## ğŸ“ æ–‡æ¡£ç»“æ„

```
refactor/
â”œâ”€â”€ README.md                            # æœ¬æ–‡ä»¶ - æ–‡æ¡£ç´¢å¼•
â”œâ”€â”€ PLUGIN_SYSTEM_REMOVAL.md             # æ’ä»¶ç³»ç»Ÿç§»é™¤è¯´æ˜
â”‚
â”œâ”€â”€ design/                              # è®¾è®¡æ–‡æ¡£
â”‚   â”œâ”€â”€ overview.md                       # æ¶æ„æ€»è§ˆï¼ˆ2025å¹´æ–°æ¶æ„ï¼‰
â”‚   â”œâ”€â”€ layer_refactoring.md              # 5å±‚æ¶æ„è®¾è®¡
â”‚   â”œâ”€â”€ decision_layer.md                 # å†³ç­–å±‚è®¾è®¡
â”‚   â”œâ”€â”€ multi_provider.md                 # å¤šProviderå¹¶å‘è®¾è®¡
â”‚   â”œâ”€â”€ core_refactoring.md               # AmaidesuCoreé‡æ„è®¾è®¡
â”‚   â”œâ”€â”€ http_server.md                    # HTTPæœåŠ¡å™¨è®¾è®¡
â”‚   â”œâ”€â”€ llm_service.md                    # LLMæœåŠ¡è®¾è®¡
â”‚   â”œâ”€â”€ event_data_contract.md            # äº‹ä»¶æ•°æ®å¥‘çº¦è®¾è®¡
â”‚   â”œâ”€â”€ pipeline_refactoring.md           # Pipelineé‡æ–°è®¾è®¡
â”‚   â”œâ”€â”€ avatar_refactoring.md             # è™šæ‹Ÿå½¢è±¡é‡æ„è®¾è®¡
â”‚   â””â”€â”€ plugin_system.md                  # âš ï¸ å·²åºŸå¼ƒ
â”‚
â””â”€â”€ plan/                                # å®æ–½è®¡åˆ’
    â””â”€â”€ 5_layer_refactoring_plan.md       # 5å±‚æ¶æ„é‡æ„å®æ–½è®¡åˆ’
```

---

## ğŸ¯ é‡æ„æ ¸å¿ƒè¦ç‚¹

### 1. 5å±‚æ ¸å¿ƒæ•°æ®æµï¼ˆ2025å¹´æ¶æ„ï¼‰

```
Layer 1-2: Inputï¼ˆè¾“å…¥æ„ŸçŸ¥ + æ ‡å‡†åŒ–ï¼‰
    â†“ NormalizedMessage
Layer 3: Decisionï¼ˆå†³ç­–å±‚ï¼Œå¯æ›¿æ¢ï¼‰
    â†“ Intent
Layer 4: Parametersï¼ˆå‚æ•°ç”Ÿæˆï¼‰
    â†“ RenderParameters
Layer 5: Renderingï¼ˆæ¸²æŸ“å‘ˆç°ï¼Œå¤šProviderå¹¶å‘ï¼‰
```

### 2. æ ¸å¿ƒå˜åŒ–

| å˜åŒ– | æ—§æ¶æ„ï¼ˆ7å±‚ï¼‰ | æ–°æ¶æ„ï¼ˆ5å±‚ï¼‰ |
|------|-------------|-------------|
| **å±‚çº§æ•°** | 7å±‚ | 5å±‚ |
| **Layer 1-2** | Input + Normalization | åˆå¹¶ä¸ºInputLayer |
| **Layer 3** | Canonicalï¼ˆä¸­é—´è¡¨ç¤ºï¼‰ | ç§»é™¤ï¼ŒåŠŸèƒ½åˆå¹¶åˆ°Layer 2 |
| **Layer 4** | Decisionï¼ˆå†³ç­–å±‚ï¼‰ | ä¸å˜ï¼Œå¯æ›¿æ¢ |
| **Layer 5** | Understandingï¼ˆç†è§£å±‚ï¼‰ | ç§»é™¤ï¼ŒåŠŸèƒ½ç”±DecisionProviderè´Ÿè´£ |
| **Layer 6** | Parametersï¼ˆå‚æ•°ç”Ÿæˆï¼‰ | ä¸å˜ |
| **Layer 7** | Renderingï¼ˆæ¸²æŸ“å±‚ï¼‰ | ä¸å˜ï¼Œé‡ç¼–å·ä¸ºLayer 5 |
| **æ’ä»¶ç³»ç»Ÿ** | å­˜åœ¨ | **å·²ç§»é™¤**ï¼Œé‡‡ç”¨çº¯Provideræ¶æ„ |

### 3. ä¸ºä»€ä¹ˆç§»é™¤æ’ä»¶ç³»ç»Ÿï¼Ÿ

è¯¦è§ï¼š[æ’ä»¶ç³»ç»Ÿç§»é™¤è¯´æ˜](./PLUGIN_SYSTEM_REMOVAL.md)

**æ ¸å¿ƒåŸå› **ï¼š
- âŒ Pluginåœ¨åˆ›å»ºProviderï¼Œè¿èƒŒäº†"ä¸åˆ›å»ºProvider"çš„è®¾è®¡åŸåˆ™
- âŒ ä¸"æ¶ˆç­æ’ä»¶åŒ–"çš„é‡æ„ç›®æ ‡ç›´æ¥çŸ›ç›¾
- âŒ å¢åŠ äº†ä¸€å±‚ä¸å¿…è¦çš„æŠ½è±¡ï¼Œåè€Œä½¿æ¶æ„æ›´å¤æ‚

**æ–°æ¶æ„ä¼˜åŠ¿**ï¼š
- âœ… Providerç”±Managerç»Ÿä¸€ç®¡ç†ï¼Œé…ç½®é©±åŠ¨å¯ç”¨
- âœ… èŒè´£è¾¹ç•Œæ˜ç¡®ï¼šProvider = åŸå­èƒ½åŠ›
- âœ… ä»£ç ç»„ç»‡æ›´æ¸…æ™°ï¼šæŒ‰æ•°æ®æµå±‚çº§ç»„ç»‡

---

## ğŸ”‘ å…³é”®è®¾è®¡æ¦‚å¿µ

### Providerï¼ˆæä¾›è€…ï¼‰

| ç±»å‹ | ä½ç½® | èŒè´£ | ç¤ºä¾‹ |
|------|------|------|------|
| **InputProvider** | Layer 1 | æ¥æ”¶å¤–éƒ¨æ•°æ®ï¼Œç”ŸæˆRawData | ConsoleInputProvider, BiliDanmakuProvider |
| **DecisionProvider** | Layer 3 | å¤„ç†NormalizedMessageï¼Œå†³ç­–å¹¶è¿”å›Intent | MaiCoreDecisionProvider, LocalLLMDecisionProvider |
| **OutputProvider** | Layer 5 | æ¥æ”¶æ¸²æŸ“å‚æ•°ï¼Œæ‰§è¡Œå®é™…è¾“å‡º | TTSProvider, SubtitleProvider, VTSProvider |

### Managerï¼ˆç®¡ç†è€…ï¼‰

- **InputProviderManager**ï¼šç®¡ç†è¾“å…¥Providerçš„ç”Ÿå‘½å‘¨æœŸ
- **DecisionManager**ï¼šç®¡ç†å†³ç­–Providerï¼Œæ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢
- **OutputProviderManager**ï¼šç®¡ç†è¾“å‡ºProviderçš„ç”Ÿå‘½å‘¨æœŸ

### é…ç½®é©±åŠ¨

```toml
# è¾“å…¥Provideré…ç½®
[input]
enabled = ["console", "bili_danmaku", "minecraft"]

[input.providers.console]
source = "stdin"

# å†³ç­–Provideré…ç½®
[decision]
default_provider = "maicore"

# è¾“å‡ºProvideré…ç½®
[output]
enabled = ["tts", "subtitle", "vts"]
```

---

## ğŸ“Š æ¶æ„æ¼”è¿›

### v1.0ï¼ˆ2024å¹´ï¼‰

- 24ä¸ªæ’ä»¶ï¼Œ18ä¸ªæœåŠ¡æ³¨å†Œ
- è¿‡åº¦æ’ä»¶åŒ–ï¼Œä¾èµ–åœ°ç‹±
- æ¨¡å—å®šä½æ¨¡ç³Š

### v2.0ï¼ˆ2025å¹´åˆï¼‰

- æ’ä»¶ç³»ç»Ÿ + Providerç³»ç»ŸåŒè½¨å¹¶è¡Œ
- Pluginåˆ›å»ºå’Œç®¡ç†Provider
- ä»ç„¶å­˜åœ¨èŒè´£è¾¹ç•Œæ¨¡ç³Šçš„é—®é¢˜

### v3.0ï¼ˆ2025å¹´2æœˆï¼Œå½“å‰ï¼‰

- **ç§»é™¤æ’ä»¶ç³»ç»Ÿ**
- Providerç”±Managerç»Ÿä¸€ç®¡ç†
- é…ç½®é©±åŠ¨å¯ç”¨/ç¦ç”¨
- 5å±‚æ¶æ„ï¼ŒèŒè´£æ¸…æ™°

---

## âœ… æˆåŠŸæ ‡å‡†

### æŠ€æœ¯æŒ‡æ ‡
- âœ… æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- âœ… é…ç½®æ–‡ä»¶è¡Œæ•°å‡å°‘40%ä»¥ä¸Š
- âœ… æ ¸å¿ƒåŠŸèƒ½å“åº”æ—¶é—´æ— å¢åŠ 
- âœ… ä»£ç é‡å¤ç‡é™ä½30%ä»¥ä¸Š
- âœ… æœåŠ¡æ³¨å†Œè°ƒç”¨å‡å°‘80%ä»¥ä¸Š
- âœ… EventBusäº‹ä»¶è°ƒç”¨è¦†ç›–ç‡90%ä»¥ä¸Š
- âœ… æ’ä»¶ç³»ç»Ÿå·²ç§»é™¤ï¼ŒProviderç”±Managerç»Ÿä¸€ç®¡ç†

### æ¶æ„æŒ‡æ ‡
- âœ… æ¸…æ™°çš„5å±‚æ ¸å¿ƒæ•°æ®æµæ¶æ„
- âœ… å†³ç­–å±‚å¯æ›¿æ¢ï¼ˆæ”¯æŒå¤šç§DecisionProviderï¼‰
- âœ… å¤šProviderå¹¶å‘æ”¯æŒï¼ˆè¾“å…¥å±‚å’Œè¾“å‡ºå±‚ï¼‰
- âœ… å±‚çº§é—´ä¾èµ–å…³ç³»æ¸…æ™°ï¼ˆå•å‘ä¾èµ–ï¼‰
- âœ… EventBusä¸ºå†…éƒ¨ä¸»è¦é€šä¿¡æ¨¡å¼
- âœ… Provideræ¨¡å¼æ›¿ä»£é‡å¤æ’ä»¶
- âœ… é…ç½®é©±åŠ¨ï¼Œæ— éœ€ä¿®æ”¹ä»£ç å³å¯å¯ç”¨/ç¦ç”¨Provider
- âœ… æ’ä»¶ç³»ç»Ÿå·²å®Œå…¨ç§»é™¤

---

## ğŸ”— ç›¸å…³èµ„æº

### è®¾è®¡æ–‡æ¡£
- [è®¾è®¡æ€»è§ˆ](./design/overview.md) - 2025å¹´æ–°æ¶æ„æ€»è§ˆ
- [5å±‚æ¶æ„è®¾è®¡](./design/layer_refactoring.md) - è¯¦ç»†æè¿°5å±‚æ ¸å¿ƒæ•°æ®æµ
- [å†³ç­–å±‚è®¾è®¡](./design/decision_layer.md) - å¯æ›¿æ¢çš„å†³ç­–Providerç³»ç»Ÿ
- [å¤šProviderå¹¶å‘è®¾è®¡](./design/multi_provider.md) - Providerç®¡ç†æ¶æ„

### å®æ–½è®¡åˆ’
- [5å±‚æ¶æ„é‡æ„å®æ–½è®¡åˆ’](./plan/5_layer_refactoring_plan.md) - è¯¦ç»†çš„é‡æ„æ­¥éª¤

### è¿ç§»æŒ‡å—
- [æ’ä»¶ç³»ç»Ÿç§»é™¤è¯´æ˜](./PLUGIN_SYSTEM_REMOVAL.md) - é…ç½®å’Œä»£ç è¿ç§»æŒ‡å—

---

## â“ å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆè¦ä»7å±‚æ”¹ä¸º5å±‚ï¼Ÿ

**A**: ç®€åŒ–æ¶æ„ï¼Œæ¶ˆé™¤å†—ä½™ï¼š
- Layer 2ï¼ˆNormalizationï¼‰å’ŒLayer 3ï¼ˆCanonicalï¼‰åˆå¹¶
- Layer 5ï¼ˆUnderstandingï¼‰çš„åŠŸèƒ½ç”±DecisionProvideræ‰¿æ‹…
- å‡å°‘æ•°æ®è½¬æ¢å¼€é”€ï¼Œæé«˜æ€§èƒ½

### Q: æ’ä»¶ç³»ç»Ÿä¸ºä»€ä¹ˆè¦ç§»é™¤ï¼Ÿ

**A**: æ’ä»¶ç³»ç»Ÿä¸"æ¶ˆç­æ’ä»¶åŒ–"çš„é‡æ„ç›®æ ‡ä¸å…¼å®¹ï¼š
- Pluginåœ¨åˆ›å»ºProviderï¼Œè¿èƒŒäº†è®¾è®¡åŸåˆ™
- å¢åŠ äº†ä¸€å±‚ä¸å¿…è¦çš„æŠ½è±¡
- çº¯Provideræ¶æ„æ›´ç®€å•ã€æ›´æ¸…æ™°

è¯¦è§ï¼š[æ’ä»¶ç³»ç»Ÿç§»é™¤è¯´æ˜](./PLUGIN_SYSTEM_REMOVAL.md)

### Q: ç¤¾åŒºå¼€å‘è€…å¦‚ä½•æ‰©å±•åŠŸèƒ½ï¼Ÿ

**A**: ç›´æ¥æ·»åŠ Providerï¼š

1. åœ¨å¯¹åº”å±‚åˆ›å»ºProvideræ–‡ä»¶ï¼š`src/layers/{layer}/providers/my_provider.py`
2. åœ¨é…ç½®ä¸­å¯ç”¨ï¼š`[input]enabled = ["console", "my_provider"]`
3. æ— éœ€åˆ›å»ºPlugin

è¯¦è§ï¼š[è®¾è®¡æ€»è§ˆ - ç¤¾åŒºæ‰©å±•](./design/overview.md#ç¤¾åŒºæ‰©å±•)

---

**æœ€åæ›´æ–°**ï¼š2025å¹´2æœˆ1æ—¥
**ç»´æŠ¤è€…**ï¼šAmaidesu Team
