# Amaidesu é‡æ„å®æ–½è®¡åˆ’

## ğŸ“‹ æ–‡æ¡£ç»“æ„

æœ¬æ–‡æ¡£æ˜¯é‡æ„å®æ–½è®¡åˆ’çš„**æ€»è§ˆå’Œç´¢å¼•**ã€‚è¯¦ç»†å†…å®¹è¯·æŸ¥çœ‹å„ä¸ªé˜¶æ®µçš„ç‹¬ç«‹æ–‡æ¡£ï¼š

- [Phase 1: åŸºç¡€è®¾æ–½æ­å»º](./01_phase1_infrastructure.md)
- [Phase 2: è¾“å…¥å±‚å®ç° (Layer 1-2)](./02_phase2_input.md)
- [Phase 3: å†³ç­–å±‚ + ä¸­é—´è¡¨ç¤º + è¡¨ç°ç†è§£ (Decision Layer + Layer 3-4)](./03_phase3_decision.md)
- [Phase 4: è¾“å‡ºå±‚å®ç° (Layer 5-6)](./04_phase4_output.md)
- [Phase 5: æ‰©å±•ç³»ç»Ÿå®ç° (Extension System)](./05_phase5_extensions.md)
- [Phase 6: æ¸…ç†ã€æµ‹è¯•å’Œè¿ç§»](./06_phase6_cleanup.md)

---

## ğŸ¯ å®æ–½åŸåˆ™

### æ ¸å¿ƒç›®æ ‡
1. **å…¨é¢é‡æ„**ï¼š1-2å¤©å†…å®Œæˆï¼Œä¸è€ƒè™‘å‘åå…¼å®¹
2. **æ¶ˆç­æ’ä»¶åŒ–**ï¼šæ ¸å¿ƒåŠŸèƒ½å…¨éƒ¨æ¨¡å—åŒ–
3. **EventBusä¼˜å…ˆ**ï¼šç”¨äº‹ä»¶ç³»ç»Ÿæ›¿ä»£æœåŠ¡æ³¨å†Œ
4. **Provideræ¨¡å¼**ï¼šç»Ÿä¸€æ¥å£ï¼Œå·¥å‚åŠ¨æ€é€‰æ‹©
5. **æ”¯æŒå¹¶å‘**ï¼šæ¯å±‚æ”¯æŒå¤šä¸ªProvideråŒæ—¶å¤„ç†
6. **å†³ç­–å±‚å¯æ›¿æ¢**ï¼šMaiCoreåªæ˜¯å†³ç­–Providerçš„ä¸€ç§å®ç°
7. **ä¿ç•™Gitå†å²**ï¼šä½¿ç”¨`git mv`è¿ç§»æ–‡ä»¶

### âš ï¸ é‡è¦ï¼šGitå†å²ä¿ç•™

**å¼ºåˆ¶è¦æ±‚**ï¼šæ‰€æœ‰æ–‡ä»¶è¿ç§»å¿…é¡»ä½¿ç”¨`git mv`å‘½ä»¤ï¼Œ**ç¦æ­¢ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿç›´æ¥ç§»åŠ¨æ–‡ä»¶**

**åŸå› **ï¼š
- `git mv`ä¼šè®°å½•æ–‡ä»¶ç§»åŠ¨ï¼ŒGitå¯ä»¥è¿½æº¯å®Œæ•´å†å²
- ç›´æ¥ç§»åŠ¨æ–‡ä»¶ä¼šå¯¼è‡´Gitä¸¢å¤±è¯¥æ–‡ä»¶çš„æäº¤å†å²
- é‡æ„åçš„ä»£ç åº”è¯¥å¯ä»¥è¿½æº¯åˆ°åŸå§‹å®ç°

**æ­£ç¡®åšæ³•**ï¼š
```bash
# âœ… æ­£ç¡®ï¼šä½¿ç”¨git mv
git mv src/plugins/minecraft src/extensions/minecraft
git commit -m "refactor: migrate minecraft to extension"

# æŸ¥çœ‹å®Œæ•´å†å²ï¼ˆåŒ…æ‹¬ç§»åŠ¨ï¼‰
git log --follow src/extensions/minecraft/
```

**é”™è¯¯åšæ³•**ï¼š
```bash
# âŒ é”™è¯¯ï¼šç›´æ¥åœ¨æ–‡ä»¶ç³»ç»Ÿç§»åŠ¨æ–‡ä»¶
mv src/plugins/mainosaba src/extensions/mainosaba
git add src/extensions/mainosaba
git commit -m "refactor: move mainosaba"
# ç»“æœï¼šGitå†å²ä¸¢å¤±ï¼
```

### å®æ–½é¡ºåº

æŒ‰ç…§æ•°æ®æµé¡ºåºï¼Œä»è¾“å…¥åˆ°è¾“å‡ºé€æ­¥é‡æ„ï¼š
```
Phase 1 (åŸºç¡€è®¾æ–½) â†’ Phase 2 (è¾“å…¥) â†’ Phase 3 (å†³ç­–+ä¸­é—´) â†’ Phase 4 (è¾“å‡º) â†’ Phase 5 (æ‰©å±•) â†’ Phase 6 (æ¸…ç†)
```

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### 6å±‚æ ¸å¿ƒæ¶æ„ + å†³ç­–å±‚ + æ‰©å±•ç³»ç»Ÿ

```
å¤–éƒ¨è¾“å…¥ï¼ˆå¼¹å¹•ã€æ¸¸æˆã€è¯­éŸ³ï¼‰
  â†“
ã€Layer 1: è¾“å…¥æ„ŸçŸ¥ã€‘å¤šä¸ªInputProviderå¹¶å‘é‡‡é›†
  â†“
ã€Layer 2: è¾“å…¥æ ‡å‡†åŒ–ã€‘ç»Ÿä¸€è½¬æ¢ä¸ºText
  â†“
ã€Layer 3: ä¸­é—´è¡¨ç¤ºã€‘æ„å»ºCanonicalMessage
  â†“
ã€å†³ç­–å±‚ï¼šDecisionProviderã€‘â­ å¯æ›¿æ¢ã€å¯æ‰©å±•
  â”œâ”€ MaiCoreDecisionProvider (é»˜è®¤ï¼‰
  â”œâ”€ LocalLLMDecisionProvider (å¯é€‰ï¼‰
  â””â”€ RuleEngineDecisionProvider (å¯é€‰ï¼‰
  â†“
ã€DecisionProviderè¿”å›MessageBaseã€‘
  â†“
ã€Layer 4: è¡¨ç°ç†è§£ã€‘è§£æMessageBase â†’ Intent
  â†“
ã€Layer 5: è¡¨ç°ç”Ÿæˆã€‘ç”ŸæˆRenderParameters
  â†“
ã€Layer 6: æ¸²æŸ“å‘ˆç°ã€‘å¤šä¸ªOutputProviderå¹¶å‘æ¸²æŸ“
  â†“
ã€æ‰©å±•ç³»ç»Ÿï¼šExtensionã€‘ç¤¾åŒºå¼€å‘çš„æ‰©å±•èƒ½åŠ›
```

### å…³é”®ç‰¹æ€§

#### 1. å†³ç­–å±‚å¯æ›¿æ¢
- MaiCoreåªæ˜¯é»˜è®¤çš„DecisionProvider
- æ”¯æŒæ·»åŠ å…¶ä»–DecisionProviderï¼ˆæœ¬åœ°LLMã€è§„åˆ™å¼•æ“ç­‰ï¼‰
- æ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢DecisionProvider
- æ”¯æŒå¤šä¸ªDecisionProviderå¹¶è¡Œ/ä¸²è¡Œå¤„ç†

#### 2. å¤šProviderå¹¶å‘å¤„ç†
- **è¾“å…¥å±‚ï¼ˆLayer 1ï¼‰**ï¼šå¤šä¸ªInputProvideråŒæ—¶é‡‡é›†æ•°æ®
  - å¼¹å¹•ã€æ¸¸æˆã€è¯­éŸ³ç­‰ä¸åŒæ¥æº
- **è¾“å‡ºå±‚ï¼ˆLayer 6ï¼‰**ï¼šå¤šä¸ªOutputProvideråŒæ—¶æ¸²æŸ“
  - å­—å¹•ã€TTSã€VTSç­‰ä¸åŒç›®æ ‡

#### 3. Provideræ¨¡å¼
- æ‰€æœ‰èƒ½åŠ›éƒ½é€šè¿‡Provideræ¥å£å®ç°
- æ”¯æŒå·¥å‚æ¨¡å¼åŠ¨æ€é€‰æ‹©å®ç°
- æ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢Provider

#### 4. EventBusé€šä¿¡
- å±‚é—´é€šè¿‡EventBusæ¾è€¦åˆ
- æ”¯æŒäº‹ä»¶è®¢é˜…/å‘å¸ƒ
- æ¶ˆé™¤æœåŠ¡æ³¨å†Œçš„ä¾èµ–åœ°ç‹±

---

## ğŸ“ æœ€ç»ˆç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ amaidesu_core.py          # ä¸­å¤®æ¢çº½ï¼ˆä¿ç•™ï¼‰
â”‚   â”œâ”€â”€ event_bus.py               # äº‹ä»¶æ€»çº¿ï¼ˆä¿ç•™ï¼‰
â”‚   â”œâ”€â”€ pipeline_manager.py        # ç®¡é“ç®¡ç†ï¼ˆä¿ç•™ï¼‰
â”‚   â”œâ”€â”€ context_manager.py         # ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆä¿ç•™ï¼‰
â”‚   â”œâ”€â”€ provider.py               # Provideræ¥å£ï¼ˆå…¬å…±APIï¼‰
â”‚   â”œâ”€â”€ decision_provider.py      # å†³ç­–Provideræ¥å£ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ extension.py              # Extensionæ¥å£
â”‚   â””â”€â”€ extension_loader.py       # æ‰©å±•åŠ è½½å™¨
â”‚
â”œâ”€â”€ perception/                   # Layer 1: è¾“å…¥æ„ŸçŸ¥
â”‚   â”œâ”€â”€ base_input.py
â”‚   â”œâ”€â”€ text/
â”‚   â”‚   â”œâ”€â”€ console_input.py
â”‚   â”‚   â””â”€â”€ danmaku/
â”‚   â”œâ”€â”€ audio/
â”‚   â”‚   â”œâ”€â”€ microphone.py
â”‚   â”‚   â””â”€â”€ stt.py
â”‚   â””â”€â”€ input_factory.py
â”‚
â”œâ”€â”€ normalization/                # Layer 2: è¾“å…¥æ ‡å‡†åŒ–
â”‚   â”œâ”€â”€ base_normalizer.py
â”‚   â”œâ”€â”€ text_normalizer.py
â”‚   â”œâ”€â”€ audio_to_text.py
â”‚   â””â”€â”€ normalizer_factory.py
â”‚
â”œâ”€â”€ canonical/                     # Layer 3: ä¸­é—´è¡¨ç¤º
â”‚   â”œâ”€â”€ canonical_message.py
â”‚   â”œâ”€â”€ message_builder.py
â”‚   â””â”€â”€ maicore_adapter.py       # MaiCoreé€‚é…å™¨
â”‚
â”œâ”€â”€ understanding/                # Layer 4: è¡¨ç°ç†è§£
â”‚   â”œâ”€â”€ response_parser.py
â”‚   â”œâ”€â”€ text_cleanup.py
â”‚   â””â”€â”€ emotion_judge.py
â”‚
â”œâ”€â”€ expression/                   # Layer 5: è¡¨ç°ç”Ÿæˆ
â”‚   â”œâ”€â”€ expression_generator.py
â”‚   â”œâ”€â”€ tts_module.py
â”‚   â””â”€â”€ action_mapper.py
â”‚
â”œâ”€â”€ rendering/                    # Layer 6: æ¸²æŸ“å‘ˆç°
â”‚   â”œâ”€â”€ base_renderer.py
â”‚   â”œâ”€â”€ subtitle_renderer.py
â”‚   â”œâ”€â”€ audio_renderer.py
â”‚   â””â”€â”€ virtual_renderer.py
â”‚
â””â”€â”€ extensions/                   # æ‰©å±•ç³»ç»Ÿï¼ˆLayer 8ï¼‰
    â”œâ”€â”€ minecraft/
    â”œâ”€â”€ warudo/
    â””â”€â”€ dg_lab/
```

extensions/                       # ç”¨æˆ·æ‰©å±•ï¼ˆæ ¹ç›®å½•ï¼Œ.gitignoreï¼‰
â”œâ”€â”€ genshin/
â””â”€â”€ mygame/
```

---

## ğŸ“Š æ’ä»¶è¿ç§»è®¡åˆ’

### è¿ç§»åˆ°æ ¸å¿ƒæ•°æ®æµï¼ˆLayer 1-6 + å†³ç­–å±‚ï¼‰

| åŸæ’ä»¶                | è¿ç§»åˆ°å±‚çº§/å±‚               | è¿ç§»æ–¹å¼                              |
| --------------------- | -------------------------- | ------------------------------------- |
| **å¼¹å¹•è¾“å…¥ç³»åˆ—(4ä¸ª)** | Layer 1                    | ç»Ÿä¸€ä¸ºInputProviderï¼Œå·¥å‚æ¨¡å¼é€‰æ‹©     |
| **æ§åˆ¶å°è¾“å…¥**        | Layer 1                    | è½¬æ¢ä¸ºConsoleInputProvider            |
| **STTç³»åˆ—(2ä¸ª)**      | Layer 1-2                  | ç»Ÿä¸€STTæ¥å£                          |
| **æ–‡æœ¬æ¸…ç†(1ä¸ª)**     | Layer 4                    | åˆå¹¶åˆ°è¡¨ç°ç†è§£å±‚                      |
| **æƒ…æ„Ÿåˆ¤æ–­(1ä¸ª)**     | Layer 4                    | åˆå¹¶åˆ°è¡¨ç°ç†è§£å±‚                      |
| **TTSç³»åˆ—(3ä¸ª)**      | Layer 5-6                  | ç»Ÿä¸€TTSæ¨¡å—ï¼ŒProvideræ¨¡å¼å®ç°         |
| **å­—å¹•(1ä¸ª)**        | Layer 6                    | è½¬æ¢ä¸ºSubtitleRenderer (OutputProvider) |
| **è™šæ‹Ÿæ¸²æŸ“ç³»åˆ—(3ä¸ª)** | Layer 6                    | ç»Ÿä¸€ä¸ºVirtualRendererï¼ŒProvideræ¨¡å¼   |
| **å…¶ä»–è¾“å…¥(2ä¸ª)**     | Layer 1                    | è½¬æ¢ä¸ºInputProvider                   |
| **å…¶ä»–æ¸²æŸ“(2ä¸ª)**     | Layer 6                    | è½¬æ¢ä¸ºOutputProvider                  |

### è¿ç§»åˆ°æ‰©å±•ç³»ç»Ÿï¼ˆLayer 8ï¼‰

| åŸæ’ä»¶              | è¿ç§»åˆ°              | æ‰©å±•ç±»å‹ |
| ------------------- | ------------------- | -------- |
| `mainosaba`         | `extensions/mainosaba/` | å†…ç½®æ‰©å±• |
| `minecraft`         | `extensions/minecraft/` | å†…ç½®æ‰©å±• |
| `warudo`            | `extensions/warudo/`    | å†…ç½®æ‰©å±• |
| `dg_lab_service`    | `extensions/dg_lab/`    | å†…ç½®æ‰©å±• |

---

## âœ… æˆåŠŸæ ‡å‡†

### æŠ€æœ¯æŒ‡æ ‡
- âœ… æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- âœ… é…ç½®æ–‡ä»¶è¡Œæ•°å‡å°‘40%ä»¥ä¸Š
- âœ… æ ¸å¿ƒåŠŸèƒ½å“åº”æ—¶é—´æ— å¢åŠ 
- âœ… ä»£ç é‡å¤ç‡é™ä½30%ä»¥ä¸Š
- âœ… æœåŠ¡æ³¨å†Œè°ƒç”¨å‡å°‘80%ä»¥ä¸Š
- âœ… EventBusäº‹ä»¶è°ƒç”¨è¦†ç›–ç‡90%ä»¥ä¸Š
- âœ… æ‰©å±•ç³»ç»Ÿæ­£å¸¸åŠ è½½å†…ç½®æ‰©å±•å’Œç”¨æˆ·æ‰©å±•

### æ¶æ„æŒ‡æ ‡
- âœ… æ¸…æ™°çš„6å±‚æ ¸å¿ƒæ•°æ®æµæ¶æ„
- âœ… å†³ç­–å±‚å¯æ›¿æ¢ï¼ˆæ”¯æŒå¤šç§DecisionProviderï¼‰
- âœ… å±‚çº§é—´ä¾èµ–å…³ç³»æ¸…æ™°ï¼ˆå•å‘ä¾èµ–ï¼‰
- âœ… EventBusä¸ºå†…éƒ¨ä¸»è¦é€šä¿¡æ¨¡å¼
- âœ… Provideræ¨¡å¼æ›¿ä»£é‡å¤æ’ä»¶
- âœ… å·¥å‚æ¨¡å¼æ”¯æŒåŠ¨æ€åˆ‡æ¢
- âœ… æ”¯æŒå¤šProviderå¹¶å‘å¤„ç†
- âœ… æ‰©å±•ç³»ç»Ÿæ”¯æŒç¤¾åŒºå¼€å‘

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æ¶æ„è®¾è®¡æ–‡æ¡£](./design.md)
- [Phase 1: åŸºç¡€è®¾æ–½æ­å»º](./01_phase1_infrastructure.md)
- [Phase 2: è¾“å…¥å±‚å®ç°](./02_phase2_input.md)
- [Phase 3: å†³ç­–å±‚ + ä¸­é—´è¡¨ç¤º + è¡¨ç°ç†è§£](./03_phase3_decision.md)
- [Phase 4: è¾“å‡ºå±‚å®ç°](./04_phase4_output.md)
- [Phase 5: æ‰©å±•ç³»ç»Ÿå®ç°](./05_phase5_extensions.md)
- [Phase 6: æ¸…ç†ã€æµ‹è¯•å’Œè¿ç§»](./06_phase6_cleanup.md)
