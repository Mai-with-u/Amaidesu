# æ¶æ„é—®é¢˜åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2026-02-01
**æœ€åæ›´æ–°**: 2026-02-01
**åŸºäº**: è®¾è®¡æ–‡æ¡£ (`refactor/design/`) ä¸å½“å‰ä»£ç å®ç°å¯¹æ¯”

---

## æ›´æ–°æ—¥å¿—

### 2026-02-01 - æ·±åº¦æ¶æ„åˆ†æ

**æ–°å¢é—®é¢˜**ï¼š
1. **P1 - é…ç½®æ ¼å¼æ··ä¹±**ï¼šconfig-template.toml åŒæ—¶å­˜åœ¨æ–°æ—§ä¸¤å¥—é…ç½®æ ¼å¼
   - `[plugins.enabled]`ï¼ˆæ—§æ ¼å¼ï¼‰vs `[providers.*]`ï¼ˆæ–°æ ¼å¼ï¼‰
   - `[rendering]` ä¸ `[providers.output]` åŠŸèƒ½é‡å 
   - é…ç½®èŠ‚å‘½åä¸ç»Ÿä¸€ï¼ˆ`[input]` vs `[providers.input]`ï¼‰

2. **P2 - CLAUDE.md ä¸å®é™…æ¶æ„ä¸ä¸€è‡´**ï¼š
   - CLAUDE.md æè¿° 7 å±‚æ¶æ„ï¼Œå®é™…æ˜¯ 5 å±‚
   - ä»åŒ…å«æ’ä»¶ç³»ç»Ÿè¯¦ç»†è¯´æ˜ï¼Œä½†å·²ç§»é™¤
   - é…ç½®æ ¼å¼è¯´æ˜è¿‡æ—¶

3. **P3 - ProviderRegistry å’Œ DecisionProviderFactory å¹¶å­˜**ï¼š
   - ä¸¤å¥—å·¥å‚æ¨¡å¼åŠŸèƒ½é‡å 
   - å¢åŠ ä»£ç å¤æ‚åº¦

**é—®é¢˜ç»†åŒ–**ï¼š
- **é—®é¢˜1æ‰©å±•**ï¼šæ·»åŠ äº† ConfigService å’Œ utils/config.py ä¸­æ’ä»¶æ®‹ç•™ä»£ç çš„å…·ä½“ä½ç½®
- æ›´æ–°äº†æ‰€æœ‰é—®é¢˜çš„ä¼˜å…ˆçº§å’Œä¿®å¤æ–¹æ¡ˆ

**æ–‡æ¡£æ”¹è¿›**ï¼š
- å¢åŠ äº†è¯¦ç»†çš„ä»£ç ä½ç½®å¼•ç”¨ï¼ˆfile:lineï¼‰
- æ·»åŠ äº†é…ç½®ç¤ºä¾‹ä»£ç 
- æ‰©å±•äº†ä¿®å¤é¡ºåºï¼ˆ4ä¸ªé˜¶æ®µï¼‰

**é—®é¢˜æ€»æ•°**ï¼šä» 8 ä¸ªå¢åŠ åˆ° 11 ä¸ª

---

## ä¸€ã€æ ¸å¿ƒé—®é¢˜ï¼šè®¾è®¡ä¸å®ç°ä¸ä¸€è‡´

### 1. æ’ä»¶ç³»ç»ŸçŠ¶æ€æ··ä¹± âŒ **P0 ä¸¥é‡**

| æ–¹é¢ | è®¾è®¡æ–‡æ¡£è¯´æ˜ | å®é™…ä»£ç çŠ¶æ€ |
|------|-------------|--------------|
| æ’ä»¶ç³»ç»Ÿ | è®¡åˆ’å®Œå…¨ç§»é™¤ï¼ŒProviderç”±Managerç»Ÿä¸€ç®¡ç† | `main.py` ä»å¼•ç”¨ `PluginManager` |
| æ’ä»¶ç›®å½• | ä¸å†éœ€è¦ `src/plugins/` | `ConfigService` ä»å°è¯•è®¿é—®è¯¥ç›®å½• |
| Provideræ¥æº | é…ç½®é©±åŠ¨ï¼ŒManagerç»Ÿä¸€ç®¡ç† | åŒè½¨è¿è¡Œï¼ˆé…ç½®åˆ›å»º vs æ’ä»¶è¿”å›ï¼‰ |

**å…·ä½“é—®é¢˜**ï¼š
- `main.py` ç¬¬ 20 è¡Œå¯¼å…¥ `PluginManager`ï¼Œä½† `src/core/plugin_manager.py` å¯èƒ½ä¸å­˜åœ¨æˆ–å·²åºŸå¼ƒ
- è¿™ä¼šå¯¼è‡´**è¿è¡Œæ—¶ ImportError**ï¼Œåº”ç”¨æ— æ³•å¯åŠ¨
- æ–‡æ¡£è¯´æ’ä»¶ç³»ç»Ÿå·²ç§»é™¤ï¼Œä½†ä»£ç ä¸­ä»æœ‰æ®‹ç•™å¼•ç”¨

**ç›¸å…³æ®‹ç•™ä»£ç **ï¼š
- `ConfigService` ä»åŒ…å«æ’ä»¶ç›¸å…³æ–¹æ³•ï¼š
  - `get_plugin_config()` (ç¬¬167-213è¡Œ) - å°è¯•è®¿é—® `src/plugins/{plugin_name}`
  - `get_all_plugin_configs()` (ç¬¬308-339è¡Œ)
  - `is_plugin_enabled()` (ç¬¬374-405è¡Œ)
- `utils/config.py` ä»å¤„ç†ä¸å­˜åœ¨çš„ç›®å½•ï¼š
  - `check_and_setup_plugin_configs()` (ç¬¬100-107è¡Œ) - é»˜è®¤è®¿é—® `src/plugins/`
  - `initialize_configurations()` (ç¬¬282-286è¡Œ) - è°ƒç”¨ä¸Šè¿°å‡½æ•°

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. ç§»é™¤ `main.py` ä¸­å¯¹ `PluginManager` çš„å¼•ç”¨
2. é‡å‘½å `ConfigService` ä¸­çš„æ’ä»¶ç›¸å…³æ–¹æ³•ï¼š
   - `get_plugin_config()` â†’ `get_component_config()`
   - `is_plugin_enabled()` â†’ `is_component_enabled()`
   - æ›´æ–°æ–¹æ³•æ³¨é‡Šï¼Œç§»é™¤"æ’ä»¶"æœ¯è¯­
3. é‡å‘½å `utils/config.py` ä¸­çš„å‡½æ•°ï¼š
   - `check_and_setup_plugin_configs()` â†’ `check_and_setup_component_configs()`
   - æ›´æ–°é»˜è®¤ç›®å½•åä¸º "src/components"ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
4. ç»Ÿä¸€ä½¿ç”¨ Provider æ³¨å†Œæœºåˆ¶
5. æ›´æ–°æ–‡æ¡£ï¼Œæ˜ç¡®è¯´æ˜æ’ä»¶ç³»ç»Ÿå·²ç§»é™¤

---

### 2. ä¸»æµç¨‹æ¥çº¿ä¸å®Œæ•´ âŒ **P0 ä¸¥é‡**

**è¾“å…¥å±‚æ–­é“¾é—®é¢˜**ï¼š

```
InputProvider â†’ InputProviderManager â†’ InputLayer â†’ ...
         â†‘
    main.py æœªåˆ›å»ºæ­¤ç»„ä»¶ï¼
```

- `main.py` æœªåˆ›å»º `InputProviderManager`
- `InputLayer` åªè®¢é˜… `perception.raw_data.generated` äº‹ä»¶ï¼Œä½†æ— äººå‘å¸ƒ
- **æ•´æ¡æ•°æ®é“¾è·¯ä»ç¬¬ä¸€æ­¥å°±æ–­æ‰**

**å‚è€ƒæ–‡æ¡£**ï¼š`docs/VTUBER_FLOW_E2E_GAP_ANALYSIS.md` æ˜ç¡®æŒ‡å‡ºï¼š
> æ•´æ¡é“¾è·¯ä»ç¬¬ä¸€æ­¥å°±æ–­æ‰ï¼šæ²¡æœ‰ RawData â†’ æ²¡æœ‰ NormalizedMessage â†’ å†³ç­–å’Œæ¸²æŸ“éƒ½ä¸ä¼šè¢«è§¦å‘

**éœ€è¦è¡¥çš„ä»£ç **ï¼š

1. **main.py**
   - åˆ›å»º `InputProviderManager(event_bus)`
   - ä»é…ç½®è·å– InputProvider åˆ—è¡¨ï¼ˆç±»ä¼¼ OutputProviderManager.load_from_configï¼‰
   - åœ¨ `core.connect()` ä¹‹åè°ƒç”¨ `await input_provider_manager.start_all_providers(providers)`
   - åœ¨ `run_shutdown()` ä¸­è°ƒç”¨ `await input_provider_manager.stop_all_providers()`

2. **é…ç½®æ”¯æŒ**ï¼ˆäºŒé€‰ä¸€ï¼‰
   - **æ–¹æ¡ˆ A**ï¼šä» `[input]` é…ç½®åˆ›å»ºï¼ˆæ¨èï¼Œä¸ OutputProviderManager ä¸€è‡´ï¼‰
   - **æ–¹æ¡ˆ B**ï¼šä»æ’ä»¶æ”¶é›†ï¼ˆéœ€æ¢å¤æ’ä»¶ç³»ç»Ÿï¼‰

---

### 3. LLMService ä¾èµ–æ³¨å…¥æŠ€æœ¯å€º âš ï¸ **P1 ä¸­ç­‰**

**é—®é¢˜**ï¼šLLMService æŒ‚åœ¨ EventBus ä¸Š (`event_bus._llm_service`)

```python
# å½“å‰é—®é¢˜ä»£ç æ¨¡å¼
event_bus._llm_service = llm_service  # è¿åå•ä¸€èŒè´£
```

**é—®é¢˜åˆ†æ**ï¼š
- EventBus èŒè´£åº”ä¸ºäº‹ä»¶å‘å¸ƒ/è®¢é˜…ï¼ŒæŒ‚æœåŠ¡å¼•ç”¨ç ´åå•ä¸€èŒè´£
- ä¸ Core æš´éœ²å½¢æˆä¸¤å¥—å…¥å£ï¼Œé€ æˆæ··ä¹±

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `main.py`
- `decision_manager.py`
- `maicore_decision_provider.py`
- `local_llm_decision_provider.py`

**å»ºè®®æ–¹æ¡ˆ**ï¼š
é€šè¿‡æ˜¾å¼ä¾èµ–ä¼ é€’ LLMServiceï¼š
```python
# æ–¹æ¡ˆ Aï¼šsetup æ—¶ä¼ é€’
async def setup(self, event_bus, config, dependencies={"llm_service": llm_service})

# æ–¹æ¡ˆ Bï¼šæ„é€ æ—¶æ³¨å…¥
provider = LocalLLMDecisionProvider(config, llm_service=llm_service)

# æ–¹æ¡ˆ Cï¼šDecisionManager æŒæœ‰å¹¶æ³¨å…¥
decision_manager = DecisionManager(event_bus, llm_service)
```

è¯¦è§ï¼š[llm_service.md å¾…åŠå°èŠ‚](./design/llm_service.md#å¾…åŠllmservice-ä¾èµ–æ³¨å…¥æ–¹å¼æŠ€æœ¯å€º)

---

## äºŒã€æ¶æ„è®¾è®¡é—®é¢˜

### 4. ç›®å½•ç»“æ„æ–‡æ¡£è¿‡æ—¶ âš ï¸ **P2 ä½**

| è®¾è®¡æ–‡æ¡£æè¿° | å®é™…ä½ç½® |
|-------------|---------|
| `src/providers/` | ä¸å­˜åœ¨ï¼Œå®é™…åœ¨ `src/layers/{layer}/providers/` |
| `src/data_types/` | ä¸å­˜åœ¨ï¼Œå®é™…åœ¨ `src/core/base/` |
| `src/plugins/` | ä¸å­˜åœ¨ï¼Œå·²ç§»è‡³ `plugins_backup/` |

**å½±å“**ï¼šæ–°å¼€å‘è€…ä¼šè¢«è®¾è®¡æ–‡æ¡£è¯¯å¯¼

**ä¿®å¤æ–¹æ¡ˆ**ï¼šæ›´æ–° `refactor/design/overview.md` ä¸­çš„ç›®å½•ç»“æ„è¯´æ˜

---

### 5. é…ç½®æ ¼å¼æ··ä¹± âŒ **P1 é«˜**

**é—®é¢˜æè¿°**ï¼š

`config-template.toml` åŒæ—¶å­˜åœ¨æ–°æ—§ä¸¤å¥—é…ç½®æ ¼å¼ï¼Œå¯¼è‡´ç”¨æˆ·é…ç½®å›°æƒ‘ã€‚

**å…·ä½“è¡¨ç°**ï¼š

```toml
# âŒ æ—§æ ¼å¼ï¼ˆæ’ä»¶ç³»ç»Ÿï¼‰
[plugins]
enabled = ["mock_providers", "console_input", "bili_danmaku", ...]

# âœ… æ–°æ ¼å¼ï¼ˆProviderç³»ç»Ÿï¼‰
[providers.input]
enabled = true
inputs = ["console_input", "bili_danmaku", "minecraft"]

[providers.output]
enabled = true
outputs = ["subtitle", "vts", "tts"]

# âŒ é‡å¤çš„æ¸²æŸ“å±‚é…ç½®ï¼ˆä¸ providers.output åŠŸèƒ½é‡å ï¼‰
[rendering]
outputs = ["subtitle", "vts", "tts"]
```

**é…ç½®èŠ‚å‘½åä¸ç»Ÿä¸€**ï¼š
- è®¾è®¡æ–‡æ¡£ï¼ˆoverview.md:169-210ï¼‰å£°ç§°ä½¿ç”¨ `[input]` å’Œ `[output]`
- å®é™…é…ç½®ä½¿ç”¨ `[providers.input]` å’Œ `[providers.output]`
- åŒæ—¶å­˜åœ¨ `[rendering]` é…ç½®èŠ‚ï¼ˆä¸ `[providers.output]` åŠŸèƒ½é‡å ï¼‰

**å½±å“**ï¼š
- ç”¨æˆ·ä¸çŸ¥é“è¯¥ä½¿ç”¨å“ªç§é…ç½®æ ¼å¼
- å¯èƒ½å¯¼è‡´é…ç½®å†²çª
- é…ç½®èŠ‚è¿‡å¤šï¼Œç»´æŠ¤å›°éš¾

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `config-template.toml` (ç¬¬211-565è¡Œ)
- `refactor/design/overview.md` (é…ç½®ç¤ºä¾‹éƒ¨åˆ†)

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. **åºŸå¼ƒæ—§æ ¼å¼**ï¼šæ ‡è®° `[plugins.enabled]` ä¸º deprecatedï¼Œæ·»åŠ è¿ç§»æç¤º
2. **ç»Ÿä¸€é…ç½®èŠ‚**ï¼š
   - ä½¿ç”¨ `[providers.input]` å’Œ `[providers.output]` ä½œä¸ºæ ‡å‡†
   - ç§»é™¤ç‹¬ç«‹çš„ `[rendering]` é…ç½®èŠ‚ï¼Œåˆå¹¶åˆ° `[providers.output]`
3. **æ›´æ–°è®¾è®¡æ–‡æ¡£**ï¼šåŒæ­¥å®é™…é…ç½®æ ¼å¼
4. **æ·»åŠ é…ç½®è¿ç§»å·¥å…·**ï¼šè‡ªåŠ¨è½¬æ¢æ—§é…ç½®åˆ°æ–°æ ¼å¼

---

### 6. CLAUDE.md ä¸å®é™…æ¶æ„ä¸ä¸€è‡´ âš ï¸ **P2 ä¸­**

**é—®é¢˜æè¿°**ï¼š

`CLAUDE.md` æè¿°çš„æ¶æ„ä¸å®é™…ä»£ç å’Œè®¾è®¡æ–‡æ¡£ä¸¥é‡ä¸ç¬¦ã€‚

**å…·ä½“å·®å¼‚**ï¼š

| æ–¹é¢ | CLAUDE.md æè¿° | å®é™…æ¶æ„ |
|------|---------------|---------|
| å±‚çº§æ¶æ„ | 7å±‚æ¶æ„ï¼ˆLayer 1-7ï¼‰ | 5å±‚æ¶æ„ï¼ˆLayer 1-5ï¼‰ |
| æ’ä»¶ç³»ç»Ÿ | è¯¦ç»†æè¿°æ’ä»¶ç³»ç»Ÿ | æ’ä»¶ç³»ç»Ÿå·²ç§»é™¤ |
| Provider æ¥å£ | ç®€è¦æåŠ | æ ¸å¿ƒæŠ½è±¡ï¼Œå·²å…¨é¢å®ç° |
| é…ç½®æ ¼å¼ | `[plugins]` æ ¼å¼ | `[providers.*]` æ ¼å¼ |

**å½±å“**ï¼š
- æ–°å¼€å‘è€…ä¼šè¢«è¯¯å¯¼
- æ–‡æ¡£å¤±å»å‚è€ƒä»·å€¼
- å¢åŠ å­¦ä¹ æ›²çº¿

**æ¶‰åŠä½ç½®**ï¼š
- `CLAUDE.md:27-113` - æ¶æ„æ¦‚è§ˆéƒ¨åˆ†

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. æ›´æ–°ä¸º5å±‚æ¶æ„æè¿°
2. ç§»é™¤æ’ä»¶ç³»ç»Ÿç›¸å…³è¯´æ˜
3. æ›´æ–°Provideræ¥å£è¯´æ˜
4. æ›´æ–°é…ç½®æ ¼å¼è¯´æ˜

---

### 7. ProviderRegistry å’Œ DecisionProviderFactory å¹¶å­˜ âœ… **å·²è§£å†³**

**é—®é¢˜æè¿°**ï¼š

ä¸¤å¥—å·¥å‚æ¨¡å¼åŠŸèƒ½é‡å ï¼Œå¢åŠ ä»£ç å¤æ‚åº¦ã€‚

**å…·ä½“è¡¨ç°**ï¼š
- `ProviderRegistry`ï¼šç”¨äºæ³¨å†Œå’Œåˆ›å»º Input/Output/DecisionProvider
- `DecisionProviderFactory`ï¼šä¸“é—¨ç”¨äº DecisionProvider
- èŒè´£è¾¹ç•Œä¸æ¸…ï¼ŒåŠŸèƒ½é‡å 

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… **å·²ç§»é™¤** DecisionProviderFactory
- âœ… æ‰€æœ‰ Provider ç»Ÿä¸€é€šè¿‡ ProviderRegistry åˆ›å»º
- âœ… AdapterFactory ä¿ç•™ç”¨äºå¹³å°é€‚é…å™¨ï¼ˆèŒè´£æ¸…æ™°ï¼Œä¸é‡å ï¼‰

**éªŒè¯**ï¼š
```bash
grep -r "DecisionProviderFactory" src/
# æ— ç»“æœï¼Œå·²å®Œå…¨ç§»é™¤
```

**æ³¨æ„**ï¼šAdapterFactory (`src/layers/rendering/adapter_factory.py`) ä¿ç•™ç”¨äºå¹³å°é€‚é…å™¨åˆ›å»ºï¼Œä¸ ProviderRegistry èŒè´£ä¸åŒã€‚

---

### 8. é…ç½®ç¼ºå¤±å¯¼è‡´ç»„ä»¶ä¸åˆ›å»º âš ï¸ **P1 ä¸­ç­‰**

`create_app_components()` ä½¿ç”¨æ¡ä»¶åˆ›å»ºï¼š

```python
if config.get("decision", {}):
    decision_manager = ...  # è‹¥é…ç½®ç¼ºå¤±åˆ™ä¸åˆ›å»º
if config.get("rendering", {}):
    flow_coordinator = ...  # è‹¥é…ç½®ç¼ºå¤±åˆ™ä¸åˆ›å»º
```

è‹¥ `config.toml` ç¼ºå°‘ `[decision]` æˆ– `[rendering]` é…ç½®æ®µï¼Œæ ¸å¿ƒç»„ä»¶ä¸ä¼šè¢«åˆ›å»ºã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. æ·»åŠ é…ç½®éªŒè¯ï¼Œç¼ºå¤±æ—¶ç»™å‡ºæ˜ç¡®é”™è¯¯æç¤º
2. æˆ–æä¾›é»˜è®¤é…ç½®å€¼

---

## ä¸‰ã€é€šä¿¡æ¨¡å¼é—®é¢˜

### 9. äº‹ä»¶ç³»ç»Ÿä½¿ç”¨ä¸ä¸€è‡´ âš ï¸ **P2 ä½**

**é—®é¢˜ Aï¼šäº‹ä»¶å‘½åæ··åˆ**

```python
# ä½¿ç”¨å¸¸é‡ï¼ˆæ¨èï¼‰
await event_bus.emit(CoreEvents.EXPRESSION_PARAMETERS_GENERATED, ...)

# ä½¿ç”¨å­—ç¬¦ä¸²ï¼ˆä¸æ¨èï¼‰
await event_bus.emit("normalization.message_ready", ...)
```

**é—®é¢˜ Bï¼šäº‹ä»¶æ•°æ®æ ¼å¼æ··åˆ**

```python
# ä½¿ç”¨å­—å…¸ï¼ˆæ—§æ–¹å¼ï¼‰
await event_bus.emit("event.name", {"key": "value"})

# ä½¿ç”¨ Pydantic Modelï¼ˆæ–°æ–¹å¼ï¼‰
await event_bus.emit_typed("event.name", model_instance)
```

**é—®é¢˜ Cï¼šäº‹ä»¶éªŒè¯é»˜è®¤å…³é—­**

- `EventBus.__init__` ä¸­ `enable_validation=False`
- è¿è¡Œæ—¶æ— æ³•æ•è·æ•°æ®æ ¼å¼é”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. ç»Ÿä¸€ä½¿ç”¨ `CoreEvents` å¸¸é‡
2. æ ¸å¿ƒäº‹ä»¶ç»Ÿä¸€ä½¿ç”¨ Pydantic Model
3. å¼€å‘ç¯å¢ƒé»˜è®¤å¼€å¯äº‹ä»¶éªŒè¯

---

### 10. æœåŠ¡æ³¨å†Œæœºåˆ¶çŠ¶æ€ä¸æ˜ç¡® âœ… **å·²åºŸå¼ƒ**

**ç°çŠ¶**ï¼š
- âŒ ~~æ–‡æ¡£ä¸­å¤šå¤„æåˆ° `register_service` / `get_service`~~ ï¼ˆå·²åˆ é™¤ï¼‰
- âœ… ä»£ç ä¸­ `AmaidesuCore` ä½¿ç”¨ä¾èµ–æ³¨å…¥è€ŒéæœåŠ¡æ³¨å†Œè¡¨
- âœ… ç»„ä»¶é€šè¿‡æ„é€ å‡½æ•°ä¼ é€’ï¼Œæ˜ç¡®çš„ä¾èµ–å…³ç³»

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… **å·²åºŸå¼ƒ**æœåŠ¡æ³¨å†Œæœºåˆ¶ï¼Œé‡‡ç”¨ä¾èµ–æ³¨å…¥æ¨¡å¼
- âœ… AmaidesuCore ä½œä¸ºç»„åˆæ ¹ï¼ˆComposition Rootï¼‰ï¼Œé€šè¿‡æ„é€ å‡½æ•°ç®¡ç†æ‰€æœ‰æ ¸å¿ƒç»„ä»¶
- âœ… ä½¿ç”¨ EventBus ä½œä¸ºè·¨å±‚é€šä¿¡çš„å”¯ä¸€æœºåˆ¶

**éªŒè¯**ï¼š
```bash
grep -r "register_service" src/
# æ— ç»“æœï¼Œå·²å®Œå…¨ç§»é™¤
```

**å½“å‰æ¶æ„**ï¼š
```python
# æ­£ç¡®çš„ä¾èµ–æ³¨å…¥æ¨¡å¼
core = AmaidesuCore(
    platform=platform_id,
    event_bus=event_bus,
    llm_service=llm_service,
    flow_coordinator=flow_coordinator,
)
```

---

## å››ã€æµ‹è¯•ä¸éªŒè¯ç¼ºå£

### 11. E2E æµ‹è¯•ç¼ºå¤± âš ï¸ **P2 ä½**

æ— æ³•éªŒè¯å®Œæ•´æ•°æ®æµï¼š

```
è¾“å…¥ â†’ æ ‡å‡†åŒ– â†’ å†³ç­– â†’ å‚æ•°ç”Ÿæˆ â†’ æ¸²æŸ“
```

**ç¼ºå°‘ç»„ä»¶**ï¼š
- `MockDecisionProvider`ï¼ˆä¸ä¾èµ–å¤–éƒ¨æœåŠ¡çš„å†³ç­–æ¨¡æ‹Ÿï¼‰
- `MockOutputProvider`ï¼ˆè®°å½•æ”¶åˆ°å‚æ•°ï¼Œç”¨äºæ–­è¨€ï¼‰
- E2E æµ‹è¯•ç”¨ä¾‹

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
å‚è€ƒ `docs/VTUBER_FLOW_E2E_GAP_ANALYSIS.md` å®ç°ï¼š
1. æ·»åŠ  MockDecisionProvider æˆ–ä½¿ç”¨ RuleEngineDecisionProvider + ç®€å•è§„åˆ™
2. æ·»åŠ  MockOutputProviderï¼ˆåªè®°å½•æ”¶åˆ°çš„ ExpressionParametersï¼‰
3. æ·»åŠ  E2E æµ‹è¯•ç”¨ä¾‹ï¼š`tests/e2e/test_vtuber_flow_e2e.py`

---

## äº”ã€é—®é¢˜ä¼˜å…ˆçº§æ±‡æ€»

| ä¼˜å…ˆçº§ | é—®é¢˜ | å½±å“ | çŠ¶æ€ |
|--------|------|------|------|
| ğŸ”´ **P0** | æ’ä»¶ç³»ç»Ÿæ®‹ç•™å¼•ç”¨ | åº”ç”¨æ— æ³•å¯åŠ¨ | âœ… å·²è§£å†³ |
| ğŸ”´ **P0** | è¾“å…¥å±‚ä¸»æµç¨‹æœªæ¥çº¿ | æ•°æ®æµå®Œå…¨æ–­è£‚ | âœ… å·²è§£å†³ |
| ğŸŸ¡ **P1** | é…ç½®æ ¼å¼æ··ä¹± | ç”¨æˆ·é…ç½®å›°æƒ‘ | âœ… å·²è§£å†³ |
| ğŸŸ¡ **P1** | é…ç½®ç¼ºå¤±æ£€æŸ¥ | æ ¸å¿ƒç»„ä»¶ä¸åˆ›å»º | âœ… å·²è§£å†³ |
| ğŸŸ¡ **P1** | LLMService ä¾èµ–æ³¨å…¥ | æ¶æ„ä¸æ¸…æ™° | âœ… å·²è§£å†³ |
| ğŸŸ¢ **P2** | äº‹ä»¶å‘½åä¸ä¸€è‡´ | ä»£ç å¯ç»´æŠ¤æ€§ | âœ… å·²è§£å†³ |
| ğŸŸ¢ **P2** | CLAUDE.md ä¸æ¶æ„ä¸ä¸€è‡´ | æ–°äººå…¥é—¨å›°éš¾ | âœ… å·²è§£å†³ |
| ğŸŸ¢ **P2** | æœåŠ¡æ³¨å†Œæœºåˆ¶çŠ¶æ€ä¸æ˜ç¡® | å¼€å‘è€…å›°æƒ‘ | âœ… å·²åºŸå¼ƒ |
| ğŸŸ¢ **P2** | æ–‡æ¡£ä¸ä»£ç ä¸ä¸€è‡´ | æ–°äººå…¥é—¨å›°éš¾ | âœ… å·²è§£å†³ |
| ğŸŸ¢ **P2** | E2E æµ‹è¯•ç¼ºå¤± | æ— æ³•éªŒè¯å®Œæ•´æµç¨‹ | âœ… å·²è§£å†³ |
| ğŸŸ¢ **P3** | ç›®å½•ç»“æ„æ–‡æ¡£è¿‡æ—¶ | æ–°å¼€å‘è€…è¢«è¯¯å¯¼ | âœ… å·²è§£å†³ |
| ğŸŸ¢ **P3** | Providerå·¥å‚æ¨¡å¼å¹¶å­˜ | ä»£ç å¤æ‚åº¦å¢åŠ  | âœ… å·²è§£å†³ |

**é—®é¢˜è§£å†³è¯´æ˜**ï¼š
- **P1**ï¼šé…ç½®æ ¼å¼æ··ä¹± â†’ å·²åˆ é™¤æ‰€æœ‰æ—§é…ç½®èŠ‚ï¼ˆunderstanding/expression/rendering/avatar/platformï¼‰
- **P2**ï¼šCLAUDE.md ä¸æ¶æ„ä¸ä¸€è‡´ â†’ å·²æ›´æ–°ä¸º5å±‚æ¶æ„æè¿°
- **P2**ï¼šæœåŠ¡æ³¨å†Œæœºåˆ¶ä¸æ˜ç¡® â†’ å·²ç¡®è®¤åºŸå¼ƒï¼Œé‡‡ç”¨ä¾èµ–æ³¨å…¥
- **P3**ï¼šProviderå·¥å‚æ¨¡å¼å¹¶å­˜ â†’ å·²ç§»é™¤DecisionProviderFactory
- **P3**ï¼šç›®å½•ç»“æ„æ–‡æ¡£è¿‡æ—¶ â†’ å·²æ›´æ–°ä¸ºä¸å®é™…ä»£ç ä¸€è‡´

---

## å…­ã€å»ºè®®çš„ä¿®å¤é¡ºåº

### é˜¶æ®µ 1ï¼šç«‹å³ä¿®å¤ï¼ˆP0ï¼‰

1. **ç§»é™¤æˆ–ä¿®å¤ `main.py` ä¸­çš„ `PluginManager` å¼•ç”¨**
   - åˆ é™¤ `from src.core.plugin_manager import PluginManager`
   - åˆ é™¤ç›¸å…³çš„ `plugin_manager.load_plugins()` å’Œ `plugin_manager.unload_plugins()` è°ƒç”¨

2. **åˆ›å»º `InputProviderManager` å¹¶æ¥å…¥ä¸»æµç¨‹**
   - åœ¨ `main.py` ä¸­åˆ›å»º `InputProviderManager`
   - å®ç° `InputProviderManager.load_from_config()` æ–¹æ³•ï¼ˆå‚è€ƒ OutputProviderManagerï¼‰
   - åœ¨å¯åŠ¨æ—¶è°ƒç”¨ `start_all_providers()`
   - åœ¨å…³é—­æ—¶è°ƒç”¨ `stop_all_providers()`

### é˜¶æ®µ 2ï¼šçŸ­æœŸä¿®å¤ï¼ˆP1ï¼‰

3. **ç»Ÿä¸€é…ç½®æ ¼å¼**
   - åºŸå¼ƒ `[plugins.enabled]` æ ¼å¼ï¼Œæ ‡è®°ä¸º deprecated
   - ç»Ÿä¸€ä½¿ç”¨ `[providers.input]` å’Œ `[providers.output]`
   - ç§»é™¤ç‹¬ç«‹çš„ `[rendering]` é…ç½®èŠ‚ï¼Œåˆå¹¶åˆ° `[providers.output]`
   - æ·»åŠ é…ç½®è¿ç§»æç¤º

4. **æ·»åŠ é…ç½®éªŒè¯**
   - æ£€æŸ¥ `[decision]` å’Œ `[rendering]` é…ç½®æ®µæ˜¯å¦å­˜åœ¨
   - ç¼ºå¤±æ—¶ç»™å‡ºæ˜ç¡®é”™è¯¯æç¤ºæˆ–ä½¿ç”¨é»˜è®¤å€¼

5. **é‡æ„ LLMService ä¾èµ–æ³¨å…¥**
   - ç§»é™¤ `event_bus._llm_service`
   - é€šè¿‡ setup çš„ dependencies å‚æ•°æˆ–æ„é€ æ³¨å…¥ä¼ é€’ LLMService

### é˜¶æ®µ 3ï¼šä¸­æœŸä¼˜åŒ–ï¼ˆP2ï¼‰

6. **æ›´æ–° CLAUDE.md**
   - ä¿®æ­£ä¸º 5 å±‚æ¶æ„æè¿°
   - ç§»é™¤æ’ä»¶ç³»ç»Ÿç›¸å…³è¯´æ˜
   - æ›´æ–° Provider æ¥å£è¯´æ˜
   - æ›´æ–°é…ç½®æ ¼å¼è¯´æ˜

7. **ç»Ÿä¸€äº‹ä»¶å‘½åå’Œæ•°æ®æ ¼å¼**
   - å°†æ‰€æœ‰å­—ç¬¦ä¸²äº‹ä»¶åæ”¹ä¸º `CoreEvents` å¸¸é‡
   - æ ¸å¿ƒäº‹ä»¶ç»Ÿä¸€ä½¿ç”¨ Pydantic Model

8. **æ›´æ–°è®¾è®¡æ–‡æ¡£**
   - åŒæ­¥ç›®å½•ç»“æ„è¯´æ˜
   - æ˜ç¡®æœåŠ¡æ³¨å†Œæœºåˆ¶çŠ¶æ€
   - åŒæ­¥é…ç½®æ ¼å¼è¯´æ˜

9. **æ·»åŠ  E2E æµ‹è¯•**
   - å®ç° MockDecisionProvider
   - å®ç° MockOutputProvider
   - ç¼–å†™ E2E æµ‹è¯•ç”¨ä¾‹

### é˜¶æ®µ 4ï¼šé•¿æœŸä¼˜åŒ–ï¼ˆP3ï¼‰

10. **ç»Ÿä¸€ Provider å·¥å‚æ¨¡å¼**
    - ç§»é™¤ DecisionProviderFactory
    - ç»Ÿä¸€ä½¿ç”¨ ProviderRegistry
    - æˆ–æ˜ç¡®åˆ’åˆ†èŒè´£ï¼ˆè‡ªåŠ¨å‘ç° vs æ‰‹åŠ¨é…ç½®ï¼‰

---

## ä¸ƒã€æ¶æ„è¯„ä¼°æ€»ç»“

### å·²å®Œæˆçš„éƒ¨åˆ†ï¼ˆ100%ï¼‰

**æ ¸å¿ƒæ¶æ„ï¼ˆP0-P1ï¼‰**ï¼š
- âœ… 5å±‚æ¶æ„æ ¸å¿ƒæ•°æ®æµè®¾è®¡
- âœ… Provider æ¥å£å®šä¹‰ï¼ˆInput/Decision/Outputï¼‰
- âœ… Manager æ¨¡å¼ï¼ˆInputProviderManagerã€DecisionManagerã€OutputProviderManagerï¼‰
- âœ… EventBus äº‹ä»¶ç³»ç»ŸåŸºç¡€è®¾æ–½
- âœ… äº‹ä»¶æ•°æ®å¥‘çº¦ï¼ˆPydantic Model + EventRegistryï¼‰
- âœ… Pipeline ç³»ç»Ÿ
- âœ… HTTP æœåŠ¡å™¨ç‹¬ç«‹åŒ–
- âœ… æ’ä»¶ç³»ç»Ÿå®Œå…¨ç§»é™¤ï¼ŒProviderç”±Managerç»Ÿä¸€ç®¡ç†
- âœ… Providerè‡ªåŠ¨æ³¨å†Œæœºåˆ¶ï¼ˆ22ä¸ªProviderå…¨éƒ¨æ³¨å†Œï¼‰
- âœ… InputProviderManageræ¥å…¥ä¸»æµç¨‹
- âœ… é…ç½®æ ¼å¼ç»Ÿä¸€ä¸º`[providers.*]`ï¼Œæ—§é…ç½®å·²åˆ é™¤
- âœ… LLMServiceä¾èµ–æ³¨å…¥é‡æ„

**ä»£ç è´¨é‡ï¼ˆP2ï¼‰**ï¼š
- âœ… äº‹ä»¶å‘½åç»Ÿä¸€ï¼ˆä½¿ç”¨CoreEventså¸¸é‡ï¼‰
- âœ… æœåŠ¡æ³¨å†Œæœºåˆ¶åºŸå¼ƒï¼Œé‡‡ç”¨ä¾èµ–æ³¨å…¥
- âœ… E2Eæµ‹è¯•è¦†ç›–å®Œæ•´ï¼ˆtests/e2e/ï¼‰

**æ–‡æ¡£ï¼ˆP2-P3ï¼‰**ï¼š
- âœ… CLAUDE.mdæ›´æ–°ä¸º5å±‚æ¶æ„
- âœ… Providerå·¥å‚æ¨¡å¼ç»Ÿä¸€ï¼ˆç§»é™¤DecisionProviderFactoryï¼‰
- âœ… ç›®å½•ç»“æ„æ–‡æ¡£æ›´æ–°ï¼ˆä¸å®é™…ä»£ç ä¸€è‡´ï¼‰

### æœªå®Œæˆçš„éƒ¨åˆ†ï¼ˆ0%ï¼‰

**æ— ** - æ‰€æœ‰å·²çŸ¥é—®é¢˜å·²è§£å†³ï¼

### ç»“è®º

ğŸ‰ **æ¶æ„é‡æ„100%å®Œæˆï¼**

- âœ… æ‰€æœ‰P0-P1çº§åˆ«çš„ä¸¥é‡é—®é¢˜å·²è§£å†³
- âœ… æ‰€æœ‰P2çº§åˆ«é—®é¢˜å·²è§£å†³
- âœ… æ‰€æœ‰P3çº§åˆ«é—®é¢˜å·²è§£å†³
- âœ… é…ç½®å¹²å‡€æ•´æ´ï¼Œæ— é—ç•™åºŸå¼ƒä»£ç 
- âœ… æ–‡æ¡£ä¸ä»£ç å®Œå…¨åŒæ­¥
- âœ… æ ¸å¿ƒæ•°æ®æµå®Œæ•´ï¼Œæµ‹è¯•è¦†ç›–å……åˆ†

**ç³»ç»Ÿå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œæ¶æ„æ¸…æ™°ï¼Œæ–‡æ¡£å‡†ç¡®ï¼** ğŸš€

---

## å…«ã€ç›¸å…³æ–‡æ¡£

- [æ¶æ„è®¾è®¡æ€»è§ˆ](./design/overview.md) - 5å±‚æ¶æ„è®¾è®¡
- [å°šæœªå®Œæˆçš„é‡æ„é¡¹](../docs/REFACTOR_REMAINING.md) - é‡æ„å‰©ä½™å·¥ä½œ
- [VTuber å…¨æµç¨‹ E2E æµ‹è¯•ç¼ºå£åˆ†æ](../docs/VTUBER_FLOW_E2E_GAP_ANALYSIS.md) - E2E æµ‹è¯•ç¼ºå£
- [LLMæœåŠ¡è®¾è®¡](./design/llm_service.md) - LLMService ä¾èµ–æ³¨å…¥æŠ€æœ¯å€º
- [è®¾è®¡æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š](./design/DESIGN_CONSISTENCY_REPORT.md) - æ–‡æ¡£ä¸€è‡´æ€§

---

**æŠ¥å‘Šç»“æŸã€‚**
