# MainosabaPlugin - 《魔法少女的魔女裁判》游戏助手插件

## 功能介绍

MainosabaPlugin 是一个专门为《魔法少女的魔女裁判》游戏设计的助手插件，通过以下功能实现自动化游戏互动：

- **屏幕截图识别**：截取游戏画面并使用视觉语言模型（VLM）识别游戏台词
- **简单文本交互**：将识别到的游戏台词原文直接发送给MaiBot，不做任何加工
- **自动游戏控制**：通过模拟鼠标点击或键盘按键自动推进游戏进程
- **响应检测机制**：检测MaiBot的任意回应后自动继续游戏，超时也会自动继续

## 安装配置

### 1. 安装依赖

```bash
pip install pyautogui
```

### 2. 配置插件

在根目录的 `config.toml` 文件中添加以下配置：

```toml
[MainosabaPlugin]
# 启用插件
enabled = true

# VLM API配置 (必须配置)
vlm_api_url = "https://api.openai.com/v1/chat/completions"
vlm_api_key = "你的OpenAI API密钥"
vlm_model = "gpt-4-vision-preview"

# 截图设置
full_screen = true  # 全屏截图
# game_region = [100, 100, 900, 700]  # 如果full_screen=false，指定截图区域

# 响应超时设置 (秒) - 等待MaiBot回应的超时时间
response_timeout = 10

# 检查间隔 (秒) - 多久检查一次游戏画面
check_interval = 1

# 游戏控制配置
auto_click = true  # 是否自动点击鼠标推进游戏
click_position = [960, 540]  # 点击位置 [x, y] - 游戏中"下一步"按钮的位置
use_enter_key = false  # 是否使用Enter键推进游戏
```

### 3. 游戏设置

1. 启动《魔法少女的魔女裁判》游戏
2. 如果需要区域截图，配置 `full_screen = false` 并设置 `game_region`
3. 配置 `click_position` 为游戏中"下一步"按钮的准确位置

## 使用方法

插件启动后会自动运行，无需手动控制：

### 工作流程

1. **自动监听**：插件启动后自动开始截屏监听游戏画面
2. **文本识别**：当检测到新的游戏台词时，自动使用VLM识别文本
3. **发送原文**：将识别到的游戏台词原文直接发送给MaiBot
4. **响应检测**：
   - 如果MaiBot发送了任何回应，立即继续游戏
   - 如果MaiBot在10秒内没有回应，超时后自动继续游戏
5. **循环进行**：重复以上过程，实现全自动游戏进程

## 工作原理

1. **屏幕监听**：插件按配置的时间间隔（默认1秒）截取全屏或指定区域的游戏画面
2. **文本识别**：使用配置的VLM API（如OpenAI GPT-4 Vision）识别游戏中的对话文本
3. **原文发送**：将识别到的文本原文直接发送给MaiBot，不做任何加工或提示
4. **响应检测**：监听MaiBot的任何消息，收到回应立即继续游戏
5. **超时机制**：如果MaiBot在配置的超时时间（默认10秒）内没有回应，自动继续游戏
6. **自动推进**：通过鼠标点击或键盘操作推进游戏到下一句台词

## 注意事项

1. **API密钥**：必须配置有效的VLM API密钥才能进行文本识别
2. **截图设置**：默认全屏截图，如需区域截图请设置 `full_screen = false`
3. **点击位置**：`click_position` 需要设置为游戏中正确的"下一步"按钮位置
4. **窗口位置**：建议全屏模式运行游戏，确保截图区域稳定
5. **自动运行**：插件启动后会自动开始，无需手动命令控制
6. **响应检测**：插件会检测MaiBot的任意消息回应，无需特定格式

## 故障排除

### 无法识别游戏文本
- 检查VLM API配置和密钥是否正确
- 确认游戏画面中有对话文本
- 验证API密钥是否有效且有足够余额

### 自动点击不工作
- 检查 `click_position` 坐标是否正确
- 确认 `auto_click` 设置为 `true`
- 确保游戏窗口在正确的位置

### 游戏不能自动继续
- 检查MaiBot是否正常工作
- 确认MaiBot能够接收消息
- 检查超时设置是否合理

### 插件无法启动
- 检查 `enabled = true` 是否设置
- 查看日志中的错误信息
- 确认所有依赖库已正确安装（`pip install pyautogui`）

## 依赖项

- `Pillow`：屏幕截图功能
- `pyautogui`：鼠标和键盘控制
- `requests`：API调用
- `maim-message`：消息格式定义